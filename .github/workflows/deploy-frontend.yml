name: Deploy Frontend to GitHub Pages

on:
  push:
    branches: [frontend]
    paths:
      - 'datasetsui/**'
      - 'sc-continuity-explorer/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout frontend branch
        uses: actions/checkout@v4
        with:
          ref: frontend

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            datasetsui/package-lock.json
            sc-continuity-explorer/package-lock.json

      # Build datasetsui
      - name: Install datasetsui dependencies
        working-directory: ./datasetsui
        run: npm ci

      - name: Build datasetsui
        working-directory: ./datasetsui
        run: npm run build

      # Build sc-continuity-explorer
      - name: Install explorer dependencies
        working-directory: ./sc-continuity-explorer
        run: npm ci

      - name: Build explorer
        working-directory: ./sc-continuity-explorer
        run: npm run build

      # Combine builds
      - name: Prepare deployment directory
        run: |
          mkdir -p deploy
          cp -r datasetsui/out/* deploy/
          mkdir -p deploy/explorer
          cp -r sc-continuity-explorer/out/* deploy/explorer/
          
          # Add .nojekyll to bypass Jekyll processing
          touch deploy/.nojekyll
          
          # Create root index.html
          cat > deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>iAODE - Single-Cell Analysis Tools</title>
            <style>
              body {
                font-family: system-ui, -apple-system, sans-serif;
                max-width: 800px;
                margin: 60px auto;
                padding: 20px;
                line-height: 1.6;
              }
              h1 { color: #2563eb; }
              .card {
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 20px;
                margin: 20px 0;
              }
              a {
                color: #2563eb;
                text-decoration: none;
              }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>ðŸ§¬ iAODE - Single-Cell Analysis Tools</h1>
            <p>Interactive tools for single-cell genomics analysis and benchmarking.</p>
            
            <div class="card">
              <h2>ðŸ“Š <a href="./datasets/">Dataset Browser</a></h2>
              <p>Browse and explore standardized single-cell ATAC-seq and RNA-seq datasets from NCBI GEO in 10X h5 format.</p>
            </div>
            
            <div class="card">
              <h2>ðŸ”¬ <a href="./explorer/">Continuity Explorer</a></h2>
              <p>Explore simulated trajectories and analyze continuity metrics across different embedding methods.</p>
            </div>
            
            <div class="card">
              <h2>ðŸ”— <a href="https://github.com/PeterPonyu/iAODE">GitHub Repository</a></h2>
              <p>View source code, documentation, and contribute to the project.</p>
            </div>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./deploy

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
